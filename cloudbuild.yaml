# Cloud Build configuration for full application deployment
steps:
  # Step 1: Build and test Django backend
  - name: 'python:3.9-slim'
    entrypoint: bash
    args:
      - -c
      - |
        cd backend
        pip install -r requirements.txt
        python manage.py test --settings=uml_diagrams_backend.settings
    id: 'test-backend'

  # Step 2: Build React frontend
  - name: 'node:18'
    entrypoint: bash
    args:
      - -c
      - |
        cd editor/my-project
        npm ci
        npm run build:prod
    id: 'build-frontend'
    waitFor: ['-']

  # Step 3: Copy built frontend to backend static files
  - name: 'gcr.io/cloud-builders/gsutil'
    entrypoint: bash
    args:
      - -c
      - |
        mkdir -p backend/static/frontend
        cp -r editor/build/* backend/static/frontend/
    id: 'copy-frontend'
    waitFor: ['build-frontend']

  # Step 4: Build and push Docker image
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'build'
      - '-t'
      - 'gcr.io/$PROJECT_ID/uml-diagrams-backend:$BUILD_ID'
      - '-t'
      - 'gcr.io/$PROJECT_ID/uml-diagrams-backend:latest'
      - './backend'
    id: 'build-image'
    waitFor: ['test-backend', 'copy-frontend']

  # Step 5: Push the Docker image
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'gcr.io/$PROJECT_ID/uml-diagrams-backend:$BUILD_ID']
    id: 'push-image'
    waitFor: ['build-image']

  # Step 6: Deploy to App Engine
  - name: 'gcr.io/cloud-builders/gcloud'
    args: ['app', 'deploy', 'backend/app.yaml', '--quiet', '--promote']
    id: 'deploy-app'
    waitFor: ['push-image']

  # Step 7: Run database migrations
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: bash
    args:
      - -c
      - |
        gcloud app deploy backend/migrate.yaml --quiet
    id: 'migrate-db'
    waitFor: ['deploy-app']

# Store images in Google Container Registry
images:
  - 'gcr.io/$PROJECT_ID/uml-diagrams-backend:$BUILD_ID'
  - 'gcr.io/$PROJECT_ID/uml-diagrams-backend:latest'

# Build options
options:
  logging: CLOUD_LOGGING_ONLY
  machineType: 'E2_HIGHCPU_8'

# Timeout for the entire build
timeout: '1800s'